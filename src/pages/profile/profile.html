<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Profile</title>
</head>

<body>
  <section id="profile">
    <h2 id="loggedIn">Not Logged In<span id="displayName"></span></h2>
    <span id="avatar"></span>
    <ul>
      <li>User ID: <span id="id"></span></li>
      <li>Email: <span id="email"></span></li>
      <li>Spotify URI: <a id="uri" href="#"></a></li>
      <li>Link: <a id="url" href="#"></a></li>
      <li>Profile Image: <span id="imgUrl"></span></li>
    </ul>
  </section>

  <script>
    async function fetchSpotifyProfile() {
      const token = localStorage.getItem("code");

      if (!token) {
        alert("No token found. Please log in.");
        return;
      }

      try {
        const result = await fetch("https://api.spotify.com/v1/me", {
          method: "GET",
          headers: {Authorization: `Bearer ${token}`}
        });

        if (!result.ok) {
          throw new Error('Failed to fetch profile');
        }

        const profile = await result.json();

        document.getElementById("loggedIn").innerText = `Logged In as ${profile.display_name}`;

        if (profile.images && profile.images.length > 0) {
          const profileImage = new Image(200, 200);
          profileImage.src = profile.images[0].url;
          document.getElementById("avatar").appendChild(profileImage);
          document.getElementById("imgUrl").innerText = profile.images[0].url;
        }

        document.getElementById("id").innerText = profile.id;
        document.getElementById("email").innerText = profile.email;
        document.getElementById("uri").innerText = profile.uri;
        document.getElementById("uri").setAttribute("href", profile.external_urls.spotify);
        document.getElementById("url").innerText = profile.href;
        document.getElementById("url").setAttribute("href", profile.href);

      } catch (error) {
        console.error('Error fetching Spotify profile:', error);
        alert('Failed to load profile. Please try again later.');
      }
    }

    fetchSpotifyProfile();
  </script>
</body>

</html>
